generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AccountType {
  B2C
  B2B
}

// ── Admin RBAC ──

enum AdminRole {
  admin       // Full system access
  cs          // Customer Service
  merch_ops   // E-commerce Operations
  design      // Design & Media
  production  // Production Scheduling
  sales       // Sales / B2B
  finance     // Finance & Accounting
  qa          // Quality Assurance / After-sales
}

model AdminUser {
  id           String    @id @default(cuid())
  email        String    @unique
  name         String
  passwordHash String
  role         AdminRole
  isActive     Boolean   @default(true)
  lastLoginAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([role, isActive])
}

enum PartnerTier {
  bronze
  silver
  gold
  platinum
}

model User {
  id                   String       @id @default(cuid())
  email                String       @unique
  name                 String?
  phone                String?
  password             String?
  accountType          AccountType  @default(B2C)
  emailVerified        Boolean      @default(false)
  emailVerifyToken     String?      @unique
  emailVerifyExpires   DateTime?
  passwordResetToken   String?      @unique
  passwordResetExpires DateTime?
  companyName          String?
  companyRole          String?
  b2bApproved          Boolean      @default(false)
  b2bApprovedAt        DateTime?

  // Partner / reseller fields
  partnerTier          PartnerTier?
  partnerDiscount      Int          @default(0)   // percentage discount (0-50)
  referredByUserId     String?
  referredBy           User?        @relation("Referrals", fields: [referredByUserId], references: [id])
  referrals            User[]       @relation("Referrals")
  inviteCode           String?      @unique       // unique code for sharing

  // SMS opt-in
  smsOptIn             Boolean      @default(false)
  smsPhone             String?

  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt
  addresses            Address[]
  orders               Order[]
  sentInvites          PartnerInvite[] @relation("InviteSender")
  abandonedCarts       AbandonedCart[]
  orderTemplates       OrderTemplate[]
  pushSubscriptions    PushSubscription[]
  apiKeys              ApiKey[]
  supportTickets       SupportTicket[]

  @@index([accountType, b2bApproved])
  @@index([inviteCode])
}

model PartnerInvite {
  id             String       @id @default(cuid())
  email          String
  companyName    String?
  token          String       @unique
  tier           PartnerTier  @default(bronze)
  discount       Int          @default(0)
  note           String?
  expiresAt      DateTime
  acceptedAt     DateTime?
  acceptedUserId String?
  invitedById    String?
  invitedBy      User?        @relation("InviteSender", fields: [invitedById], references: [id])
  createdAt      DateTime     @default(now())

  @@index([email])
  @@index([token])
  @@index([expiresAt])
}

model Address {
  id                String   @id @default(cuid())
  userId            String
  label             String?
  name              String?
  phone             String?
  company           String?
  line1             String
  line2             String?
  city              String
  state             String?
  postalCode        String
  country           String   @default("CA")
  isDefaultShipping Boolean  @default(false)
  isDefaultBilling  Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Product {
  id              String          @id @default(cuid())
  type            ProductType     @default(sticker)
  category        String
  slug            String          @unique
  name            String
  description     String?
  basePrice       Int
  pricingUnit     PricingUnit
  minWidthIn      Float?
  minHeightIn     Float?
  maxWidthIn      Float?
  maxHeightIn     Float?
  acceptedFormats Json?
  minDpi          Int?
  requiresBleed   Boolean         @default(false)
  bleedIn         Float?
  templateUrl     String?
  minPrice        Int?
  displayFromPrice Int?
  pricingConfig   Json?
  optionsConfig   Json?
  pricingPresetId String?
  pricingPreset   PricingPreset?  @relation(fields: [pricingPresetId], references: [id])
  // Inventory tracking
  trackInventory  Boolean         @default(false)
  stockQuantity   Int             @default(0)
  lowStockThreshold Int           @default(10)
  reservedQuantity Int            @default(0)

  isActive        Boolean         @default(true)
  sortOrder       Int             @default(0)
  metaTitle       String?
  metaDescription String?
  keywords        String[]
  tags            String[]        @default([])
  isFeatured      Boolean         @default(false)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  images          ProductImage[]

  @@index([category, isActive, sortOrder])
  @@index([pricingPresetId])
}

model PricingPreset {
  id        String       @id @default(cuid())
  key       String       @unique
  name      String
  model     PricingModel
  config    Json
  isActive  Boolean      @default(true)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  products  Product[]

  @@index([model, isActive])
}

model Material {
  id           String   @id @default(cuid())
  sortOrder    Int      @default(0)
  type         String   // "Adhesive Vinyl", "Non-Adhesive", "Banner"
  name         String
  family       String?  // "Frontlit", "Mesh", "Double-Sided"
  rollSpec     String?  // "54"×150' | 4mil | Gloss | Perm"
  minWidthIn   Float?   @default(9)
  widthIn      Float?
  minLengthFt  Float?   @default(10)
  lengthFt     Float?
  lengthIn     Float?
  thickness    String?  // mil or gsm
  texture      String?
  rollCost     Float    @default(0)
  sqftPerRoll  Float    @default(0)
  costPerSqft  Float    @default(0)
  costPerSqm   Float    @default(0)
  lamination   String?
  printMode    String   @default("cmyk")
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([type, isActive])
  @@index([sortOrder])
}

model ProductImage {
  id        String   @id @default(cuid())
  productId String
  url       String
  alt       String?
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId, sortOrder])
}

model Order {
  id                    String           @id @default(cuid())

  // Stripe
  stripeSessionId       String?          @unique
  stripePaymentIntentId String?          @unique

  // Customer info
  customerEmail         String
  customerName          String?
  customerPhone         String?
  userId                String?
  user                  User?            @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Amounts (cents)
  subtotalAmount        Int              @default(0)
  taxAmount             Int              @default(0)
  shippingAmount        Int              @default(0)
  discountAmount        Int              @default(0)
  totalAmount           Int              @default(0)
  currency              String           @default("cad")

  // Status
  status                OrderStatus      @default(pending)
  paymentStatus         PaymentStatus    @default(unpaid)
  productionStatus      ProductionStatus @default(not_started)

  // Order metadata
  tags                  String[]
  priority              Int              @default(0)
  isArchived            Boolean          @default(false)
  estimatedCompletion   DateTime?
  cancelReason          String?
  refundAmount          Int              @default(0)
  couponId              String?

  // Timestamps
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  paidAt                DateTime?

  // Relations
  items                 OrderItem[]
  notes                 OrderNote[]
  files                 OrderFile[]
  timeline              OrderTimeline[]
  proofs                OrderProof[]
  coupon                Coupon?          @relation(fields: [couponId], references: [id])

  @@index([status, paymentStatus])
  @@index([customerEmail])
  @@index([userId])
  @@index([isArchived])
  @@index([createdAt])
  @@index([paidAt])
}

model OrderItem {
  id          String   @id @default(cuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId   String?
  productName String
  productType String   @default("custom")
  quantity    Int      @default(1)
  unitPrice   Int      @default(0)
  totalPrice  Int      @default(0)
  widthIn     Float?
  heightIn    Float?
  material    String?
  finishing   String?
  meta        Json?
  specsJson   Json?
  fileKey     String?
  fileUrl     String?
  fileName    String?
  createdAt   DateTime @default(now())

  productionJob ProductionJob?

  @@index([orderId])
  @@index([productId])
}

model OrderFile {
  id              String          @id @default(cuid())
  orderId         String
  fileUrl         String
  storageKey      String?
  fileName        String?
  mimeType        String?
  fileExt         String?
  sizeBytes       BigInt?
  widthPx         Int?
  heightPx        Int?
  widthIn         Float?
  heightIn        Float?
  dpi             Int?
  colorMode       ColorMode       @default(unknown)
  hasBleed        Boolean?
  bleedIn         Float?
  preflightResult Json?
  preflightStatus PreflightStatus @default(pending)
  reviewedBy      String?
  reviewedAt      DateTime?
  createdAt       DateTime        @default(now())
  order           Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([preflightStatus])
}

model OrderNote {
  id         String         @id @default(cuid())
  orderId    String
  authorType NoteAuthorType
  isInternal Boolean        @default(false)
  message    String
  createdAt  DateTime       @default(now())
  order      Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId, createdAt])
}

model OrderTimeline {
  id        String   @id @default(cuid())
  orderId   String
  action    String
  details   String?
  actor     String   @default("system")
  createdAt DateTime @default(now())
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId, createdAt])
}

model OrderProof {
  id              String      @id @default(cuid())
  orderId         String
  order           Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  version         Int         @default(1)
  imageUrl        String
  fileName        String?
  notes           String?       // Admin notes when uploading
  status          ProofStatus   @default(pending)
  customerComment String?       // Customer feedback
  reviewedAt      DateTime?
  uploadedBy      String?       // Admin who uploaded
  createdAt       DateTime      @default(now())

  @@index([orderId])
  @@index([status])
}

model Review {
  id          String   @id @default(cuid())
  productId   String
  userId      String?
  customerName String
  customerEmail String
  rating      Int        // 1-5
  title       String?
  body        String
  isApproved  Boolean    @default(false)
  isVerified  Boolean    @default(false) // purchased this product
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([productId, isApproved])
  @@index([userId])
  @@index([createdAt])
}

model Coupon {
  id           String   @id @default(cuid())
  code         String   @unique
  type         String   // percentage, fixed
  value        Int      // cents or percentage * 100
  minAmount    Int?     // minimum order amount in cents
  maxUses      Int?
  usedCount    Int      @default(0)
  validFrom    DateTime
  validTo      DateTime
  isActive     Boolean  @default(true)
  description  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  orders       Order[]

  @@index([code, isActive])
}

model EmailLog {
  id        String   @id @default(cuid())
  to        String
  subject   String
  template  String
  body      String?
  status    String   @default("sent")
  orderId   String?
  error     String?
  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([to])
}

model ActivityLog {
  id        String   @id @default(cuid())
  action    String
  entity    String
  entityId  String?
  actor     String   @default("admin")
  details   Json?
  createdAt DateTime @default(now())

  @@index([entity, entityId])
  @@index([createdAt])
}

model Setting {
  id    String @id @default(cuid())
  key   String @unique
  value Json
}

// ── Asset Management ──

enum AssetStatus {
  uploaded
  processing
  published
  archived
}

enum AssetPurpose {
  hero
  gallery
  card
  thumbnail
  logo
  banner
  background
  other
}

model Asset {
  id            String      @id @default(cuid())

  // Identity & dedup
  sha256        String      @unique
  originalName  String

  // Storage
  originalUrl   String
  storageKey    String?

  // Metadata
  mimeType      String
  sizeBytes     Int
  widthPx       Int
  heightPx      Int
  dpi           Int?
  colorSpace    String?
  hasAlpha      Boolean     @default(false)

  // Smart cropping
  focalX        Float       @default(0.5)
  focalY        Float       @default(0.5)

  // SEO & accessibility
  altText       String?
  altTextZh     String?
  caption       String?
  tags          String[]    @default([])

  // Lifecycle
  status        AssetStatus @default(uploaded)
  version       Int         @default(1)
  replacedById  String?

  // Audit
  uploadedBy    String      @default("system")
  publishedAt   DateTime?
  archivedAt    DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  links         AssetLink[]
  replacedBy    Asset?      @relation("AssetVersions", fields: [replacedById], references: [id])
  replacements  Asset[]     @relation("AssetVersions")

  @@index([sha256])
  @@index([status])
  @@index([tags])
  @@index([createdAt])
  @@index([uploadedBy])
}

model AssetLink {
  id          String       @id @default(cuid())
  assetId     String
  asset       Asset        @relation(fields: [assetId], references: [id], onDelete: Cascade)

  // Polymorphic binding
  entityType  String
  entityId    String

  // Usage context
  purpose     AssetPurpose @default(gallery)
  sortOrder   Int          @default(0)

  // Override per-link
  altOverride String?

  createdAt   DateTime     @default(now())

  @@unique([assetId, entityType, entityId, purpose, sortOrder])
  @@index([entityType, entityId, sortOrder])
  @@index([assetId])
}

// Enums

enum OrderStatus {
  draft
  pending
  paid
  canceled
  refunded
}

enum PaymentStatus {
  unpaid
  paid
  failed
  refunded
  partially_refunded
}

enum ProductionStatus {
  not_started
  preflight
  in_production
  ready_to_ship
  shipped
  completed
  on_hold
  canceled
}

enum PreflightStatus {
  pending
  approved
  rejected
}

enum ProofStatus {
  pending
  approved
  rejected
  revised
}

enum ProductType {
  sticker
  label
  sign
  other
}

enum PricingUnit {
  per_sqft
  per_piece
}

enum PricingModel {
  AREA_TIERED
  QTY_TIERED
  QTY_OPTIONS
  COST_PLUS
}

enum ColorMode {
  cmyk
  rgb
  grayscale
  spot
  unknown
}

enum NoteAuthorType {
  customer
  staff
  system
}

enum TicketStatus {
  open
  in_progress
  waiting_customer
  resolved
  closed
}

enum TicketPriority {
  low
  normal
  high
  urgent
}

enum JobStatus {
  queued
  assigned
  printing
  quality_check
  finished
  shipped
  on_hold
}

enum Priority {
  normal
  rush
  urgent
}

// Production Management

model Factory {
  id           String          @id @default(cuid())
  name         String
  location     String?
  capabilities Json?
  isActive     Boolean         @default(true)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  jobs         ProductionJob[]

  @@index([isActive])
}

model ProductionJob {
  id          String    @id @default(cuid())
  orderItemId String    @unique
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  status      JobStatus @default(queued)
  priority    Priority  @default(normal)
  factoryId   String?
  factory     Factory?  @relation(fields: [factoryId], references: [id])
  assignedTo  String?
  dueAt       DateTime?
  startedAt   DateTime?
  completedAt DateTime?
  notes       String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  events      JobEvent[]

  @@index([status, priority])
  @@index([factoryId])
  @@index([createdAt])
}

model JobEvent {
  id           String        @id @default(cuid())
  jobId        String
  job          ProductionJob @relation(fields: [jobId], references: [id], onDelete: Cascade)
  type         String
  payload      Json?
  operatorName String?
  createdAt    DateTime      @default(now())

  @@index([jobId, createdAt])
}

model AssignmentRule {
  id            String    @id @default(cuid())
  name          String
  priority      Int
  isActive      Boolean   @default(true)
  conditions    Json
  action        Json
  triggerCount  Int       @default(0)
  lastTriggered DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([isActive, priority])
}

// ── Quality Control ──

enum DefectSeverity {
  minor       // Cosmetic, customer may accept
  major       // Significant deviation from spec
  critical    // Unusable, must reprint
}

enum QCResolution {
  pending     // Awaiting decision
  accepted    // Ship as-is (minor defects)
  reprint     // Reprint the item
  refund      // Refund the customer
  discounted  // Ship with partial refund
}

model QCReport {
  id            String         @id @default(cuid())
  orderId       String
  orderItemId   String?
  jobId         String?

  // Defect details
  defectType    String         // color_mismatch, cut_error, print_defect, material_defect, damage, other
  severity      DefectSeverity
  description   String
  photoUrls     String[]       @default([])

  // Resolution
  resolution    QCResolution   @default(pending)
  resolvedBy    String?
  resolvedAt    DateTime?
  resolutionNote String?

  // Reprint tracking
  reprintJobId  String?        // New ProductionJob if reprinted

  // Audit
  reportedBy    String         // AdminUser id or name
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([orderId])
  @@index([orderItemId])
  @@index([resolution])
  @@index([severity])
  @@index([createdAt])
}

// ── Abandoned Cart Recovery ──

model AbandonedCart {
  id            String    @id @default(cuid())
  userId        String?
  user          User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  email         String
  cartJson      Json
  recoveryToken String    @unique
  emailsSent    Int       @default(0)
  lastEmailAt   DateTime?
  recoveredAt   DateTime?
  checkoutSessionId String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([email])
  @@index([recoveryToken])
  @@index([recoveredAt])
  @@index([createdAt])
}

// ── B2B Order Templates ──

model OrderTemplate {
  id          String              @id @default(cuid())
  userId      String
  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  description String?
  items       OrderTemplateItem[]
  lastUsedAt  DateTime?
  useCount    Int                 @default(0)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  @@index([userId])
}

model OrderTemplateItem {
  id          String        @id @default(cuid())
  templateId  String
  template    OrderTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  productId   String?
  productName String
  quantity    Int           @default(1)
  options     Json?
  sortOrder   Int           @default(0)

  @@index([templateId])
}

// ── Push Notifications ──

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now())

  @@index([userId])
}

// ── API Keys (B2B Bulk API) ──

model ApiKey {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  keyHash     String    @unique
  keyPrefix   String
  lastUsedAt  DateTime?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())

  @@index([userId])
  @@index([keyHash])
}

// ── Support Tickets ──

model SupportTicket {
  id          String         @id @default(cuid())
  userId      String?
  user        User?          @relation(fields: [userId], references: [id], onDelete: SetNull)
  email       String
  subject     String
  orderId     String?
  status      TicketStatus   @default(open)
  priority    TicketPriority @default(normal)
  messages    TicketMessage[]
  closedAt    DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([userId])
  @@index([status])
  @@index([email])
  @@index([createdAt])
}

model TicketMessage {
  id         String        @id @default(cuid())
  ticketId   String
  ticket     SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  authorType NoteAuthorType
  authorName String?
  body       String
  attachments String[]     @default([])
  createdAt  DateTime      @default(now())

  @@index([ticketId, createdAt])
}

// Rate limiting — persists across serverless cold starts
model LoginAttempt {
  id        String   @id @default(cuid())
  ip        String
  route     String   // e.g. "admin-login", "auth-login", "forgot-password"
  success   Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([ip, route, createdAt])
}
