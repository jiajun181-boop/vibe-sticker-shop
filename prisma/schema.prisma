// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS ---

enum OrderStatus {
  draft
  pending
  paid
  canceled
  refunded
}

enum PaymentStatus {
  unpaid
  paid
  failed
  refunded
  partially_refunded
}

enum ProductionStatus {
  not_started
  preflight
  in_production
  ready_to_ship
  shipped
  completed
  on_hold
  canceled
}

enum PreflightStatus {
  pending
  approved
  rejected
}

enum ProductType {
  sticker
  label
  sign
  other
}

enum PricingUnit {
  per_sqft
  per_piece
}

enum ColorMode {
  cmyk
  rgb
  grayscale
  spot
  unknown
}

enum NoteAuthorType {
  customer
  staff
  system
}

// --- MODELS ---

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  phone     String?

  addresses Address[]
  orders    Order[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Address {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  label     String?
  name      String?
  phone     String?
  company   String?

  line1      String
  line2      String?
  city       String
  state      String?
  postalCode String
  country    String   @default("CA")

  isDefaultShipping Boolean @default(false)
  isDefaultBilling  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model Product {
  id           String      @id @default(cuid())

  type         ProductType @default(sticker)
  category     String
  slug         String      @unique
  name         String
  description  String?

  basePrice    Int         // cents
  pricingUnit  PricingUnit

  minWidthIn   Float?
  minHeightIn  Float?
  maxWidthIn   Float?
  maxHeightIn  Float?

  // ✅ 改为 Json? 以兼容 Seed 中的数组写法
  acceptedFormats Json?
  minDpi          Int?
  requiresBleed   Boolean     @default(false)
  bleedIn         Float?
  templateUrl     String?

  pricingConfig   Json?
  optionsConfig   Json?

  isActive     Boolean     @default(true)
  sortOrder    Int         @default(0)

  images       ProductImage[]
  orderItems   OrderItem[]

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([category, isActive, sortOrder])
}

model ProductImage {
  id        String   @id @default(cuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  url       String
  alt       String?
  sortOrder Int      @default(0)

  createdAt DateTime @default(now())

  @@index([productId, sortOrder])
}

model Order {
  id              String           @id @default(cuid())
  orderNumber     Int              @unique @default(autoincrement())

  stripeSessionId String?          @unique
  paymentIntentId String?          @unique

  status           OrderStatus       @default(pending)
  paymentStatus    PaymentStatus     @default(unpaid)
  productionStatus ProductionStatus  @default(not_started)

  currency        String           @default("cad")
  totalAmount     Int              @default(0)
  subtotalAmount  Int              @default(0)
  taxAmount       Int              @default(0)
  shippingAmount  Int              @default(0)
  discountAmount  Int              @default(0)

  userId          String?
  user            User?            @relation(fields: [userId], references: [id], onDelete: SetNull)

  customerEmail   String?
  customerName    String?
  customerPhone   String?

  shippingAddrSnapshot Json?
  shippingName    String?
  shippingPhone   String?

  items           OrderItem[]
  files           OrderFile[]
  notes           OrderNote[]

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([status, paymentStatus, productionStatus])
  @@index([createdAt])
  @@index([customerEmail])
}

model OrderItem {
  id                  String      @id @default(cuid())

  orderId             String
  order               Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId           String?
  product             Product?    @relation(fields: [productId], references: [id], onDelete: SetNull)

  productType         String?
  productSlug         String?
  name                String

  unitAmount          Int         @default(0)
  cartQuantity        Int         @default(1)
  lineTotal           Int         @default(0)

  printQuantity       Int

  widthIn             Float?
  heightIn            Float?
  material            String?
  finishing           String?

  customOptions       Json?
  specialInstructions String?

  files               OrderFile[]

  createdAt           DateTime    @default(now())

  @@index([orderId])
  @@index([productId])
}

model OrderFile {
  id              String          @id @default(cuid())

  orderId         String
  order           Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)

  orderItemId     String?
  orderItem       OrderItem?      @relation(fields: [orderItemId], references: [id], onDelete: SetNull)

  fileUrl         String
  storageKey      String?
  fileName        String?
  mimeType        String?
  fileExt         String?

  sizeBytes       BigInt?
  widthPx         Int?
  heightPx        Int?
  widthIn         Float?
  heightIn        Float?

  dpi             Int?
  colorMode       ColorMode       @default(unknown)
  hasBleed        Boolean?
  bleedIn         Float?

  preflightResult Json?
  preflightStatus PreflightStatus @default(pending)

  reviewedBy      String?
  reviewedAt      DateTime?

  createdAt       DateTime        @default(now())

  @@index([orderId])
  @@index([orderItemId])
  @@index([preflightStatus])
}

model OrderNote {
  id         String         @id @default(cuid())

  orderId    String
  order      Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)

  authorType NoteAuthorType
  isInternal Boolean        @default(false)
  message    String

  createdAt  DateTime       @default(now())

  @@index([orderId, createdAt])
}