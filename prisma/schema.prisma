generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String    @id @default(cuid())
  email     String    @unique
  name      String?
  phone     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  addresses Address[]
}

model Address {
  id                String   @id @default(cuid())
  userId            String
  label             String?
  name              String?
  phone             String?
  company           String?
  line1             String
  line2             String?
  city              String
  state             String?
  postalCode        String
  country           String   @default("CA")
  isDefaultShipping Boolean  @default(false)
  isDefaultBilling  Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Product {
  id              String         @id @default(cuid())
  type            ProductType    @default(sticker)
  category        String
  slug            String         @unique
  name            String
  description     String?
  basePrice       Int
  pricingUnit     PricingUnit
  minWidthIn      Float?
  minHeightIn     Float?
  maxWidthIn      Float?
  maxHeightIn     Float?
  acceptedFormats Json?
  minDpi          Int?
  requiresBleed   Boolean        @default(false)
  bleedIn         Float?
  templateUrl     String?
  pricingConfig   Json?
  optionsConfig   Json?
  isActive        Boolean        @default(true)
  sortOrder       Int            @default(0)
  metaTitle       String?
  metaDescription String?
  keywords        String[]
  tags            String[]       @default([])
  isFeatured      Boolean        @default(false)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  images          ProductImage[]

  @@index([category, isActive, sortOrder])
}

model ProductImage {
  id        String   @id @default(cuid())
  productId String
  url       String
  alt       String?
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId, sortOrder])
}

model Order {
  id                    String           @id @default(cuid())

  // Stripe
  stripeSessionId       String?          @unique
  stripePaymentIntentId String?          @unique

  // Customer info
  customerEmail         String
  customerName          String?
  customerPhone         String?

  // Amounts (cents)
  subtotalAmount        Int              @default(0)
  taxAmount             Int              @default(0)
  shippingAmount        Int              @default(0)
  discountAmount        Int              @default(0)
  totalAmount           Int              @default(0)
  currency              String           @default("cad")

  // Status
  status                OrderStatus      @default(pending)
  paymentStatus         PaymentStatus    @default(unpaid)
  productionStatus      ProductionStatus @default(not_started)

  // Order metadata
  tags                  String[]
  priority              Int              @default(0)
  isArchived            Boolean          @default(false)
  estimatedCompletion   DateTime?
  cancelReason          String?
  refundAmount          Int              @default(0)
  couponId              String?

  // Timestamps
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  paidAt                DateTime?

  // Relations
  items                 OrderItem[]
  notes                 OrderNote[]
  files                 OrderFile[]
  timeline              OrderTimeline[]
  coupon                Coupon?          @relation(fields: [couponId], references: [id])

  @@index([status, paymentStatus])
  @@index([customerEmail])
  @@index([isArchived])
}

model OrderItem {
  id          String   @id @default(cuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId   String?
  productName String
  productType String   @default("custom")
  quantity    Int      @default(1)
  unitPrice   Int      @default(0)
  totalPrice  Int      @default(0)
  widthIn     Float?
  heightIn    Float?
  material    String?
  finishing   String?
  meta        Json?
  specsJson   Json?
  fileKey     String?
  fileUrl     String?
  fileName    String?
  createdAt   DateTime @default(now())

  productionJob ProductionJob?

  @@index([orderId])
  @@index([productId])
}

model OrderFile {
  id              String          @id @default(cuid())
  orderId         String
  fileUrl         String
  storageKey      String?
  fileName        String?
  mimeType        String?
  fileExt         String?
  sizeBytes       BigInt?
  widthPx         Int?
  heightPx        Int?
  widthIn         Float?
  heightIn        Float?
  dpi             Int?
  colorMode       ColorMode       @default(unknown)
  hasBleed        Boolean?
  bleedIn         Float?
  preflightResult Json?
  preflightStatus PreflightStatus @default(pending)
  reviewedBy      String?
  reviewedAt      DateTime?
  createdAt       DateTime        @default(now())
  order           Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([preflightStatus])
}

model OrderNote {
  id         String         @id @default(cuid())
  orderId    String
  authorType NoteAuthorType
  isInternal Boolean        @default(false)
  message    String
  createdAt  DateTime       @default(now())
  order      Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId, createdAt])
}

model OrderTimeline {
  id        String   @id @default(cuid())
  orderId   String
  action    String
  details   String?
  actor     String   @default("system")
  createdAt DateTime @default(now())
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId, createdAt])
}

model Coupon {
  id           String   @id @default(cuid())
  code         String   @unique
  type         String   // percentage, fixed
  value        Int      // cents or percentage * 100
  minAmount    Int?     // minimum order amount in cents
  maxUses      Int?
  usedCount    Int      @default(0)
  validFrom    DateTime
  validTo      DateTime
  isActive     Boolean  @default(true)
  description  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  orders       Order[]

  @@index([code, isActive])
}

model EmailLog {
  id        String   @id @default(cuid())
  to        String
  subject   String
  template  String
  body      String?
  status    String   @default("sent")
  orderId   String?
  error     String?
  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([to])
}

model ActivityLog {
  id        String   @id @default(cuid())
  action    String
  entity    String
  entityId  String?
  actor     String   @default("admin")
  details   Json?
  createdAt DateTime @default(now())

  @@index([entity, entityId])
  @@index([createdAt])
}

model Setting {
  id    String @id @default(cuid())
  key   String @unique
  value Json
}

// Enums

enum OrderStatus {
  draft
  pending
  paid
  canceled
  refunded
}

enum PaymentStatus {
  unpaid
  paid
  failed
  refunded
  partially_refunded
}

enum ProductionStatus {
  not_started
  preflight
  in_production
  ready_to_ship
  shipped
  completed
  on_hold
  canceled
}

enum PreflightStatus {
  pending
  approved
  rejected
}

enum ProductType {
  sticker
  label
  sign
  other
}

enum PricingUnit {
  per_sqft
  per_piece
}

enum ColorMode {
  cmyk
  rgb
  grayscale
  spot
  unknown
}

enum NoteAuthorType {
  customer
  staff
  system
}

enum JobStatus {
  queued
  assigned
  printing
  quality_check
  finished
  shipped
  on_hold
}

enum Priority {
  normal
  rush
  urgent
}

// Production Management

model Factory {
  id           String          @id @default(cuid())
  name         String
  location     String?
  capabilities Json?
  isActive     Boolean         @default(true)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  jobs         ProductionJob[]

  @@index([isActive])
}

model ProductionJob {
  id          String    @id @default(cuid())
  orderItemId String    @unique
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  status      JobStatus @default(queued)
  priority    Priority  @default(normal)
  factoryId   String?
  factory     Factory?  @relation(fields: [factoryId], references: [id])
  assignedTo  String?
  dueAt       DateTime?
  startedAt   DateTime?
  completedAt DateTime?
  notes       String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  events      JobEvent[]

  @@index([status, priority])
  @@index([factoryId])
  @@index([createdAt])
}

model JobEvent {
  id           String        @id @default(cuid())
  jobId        String
  job          ProductionJob @relation(fields: [jobId], references: [id], onDelete: Cascade)
  type         String
  payload      Json?
  operatorName String?
  createdAt    DateTime      @default(now())

  @@index([jobId, createdAt])
}

model AssignmentRule {
  id            String    @id @default(cuid())
  name          String
  priority      Int
  isActive      Boolean   @default(true)
  conditions    Json
  action        Json
  triggerCount  Int       @default(0)
  lastTriggered DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([isActive, priority])
}
